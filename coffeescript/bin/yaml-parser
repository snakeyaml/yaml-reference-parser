#!/usr/bin/env coffee

require '../lib/prelude'
require '../lib/parser'
require '../lib/test-receiver'

main = (yaml=file_read('-'))->

  parser = new Parser(new TestReceiver)

  pass = true
  start = timer()

  try
    parser.parse(yaml)
  catch e
    warn e
    pass = false

  time = timer(start)

  if yaml.match /\n./
    n = "\n"
  else
    n = ''
    yaml = yaml.replace /\n$/, '\\n'

  if process.env.STATS
    sorted = {}
    {calls} = parser.stats
    for k in Object.keys(calls).sort((a,b)-> calls[a] - calls[b])
      sorted[k] = calls[k]
    WWW sorted

  if pass
    say "PASS - '#{n}#{yaml}'"
    say parser.receiver.output()
    say sprintf "Parse time %.5fs", time
    return true
  else
    say "FAIL - '#{n}#{yaml}'"
    say parser.receiver.output()
    say sprintf "Parse time %.5fs", time
    return false

if main process.argv[2..]...
  exit 0
else
  exit 1

# vim: sw=2:
